import os
import json
import re
from datetime import datetime, timedelta, timezone
from openai import OpenAI
from tqdm import tqdm
from PIL import Image, ImageDraw, ImageFont
import requests
from io import BytesIO

# é…ç½®DeepSeek API
BASE_URL = "https://api.deepseek.com"
API_KEY = os.environ.get("DEEPSEEK_API_KEY", "your_deepseek_api_key")  # ä»ç¯å¢ƒå˜é‡è·å–API key

client = OpenAI(
    base_url=BASE_URL,
    api_key=API_KEY
)

# è·å–å½“å‰UTCæ—¶é—´
current_utc_time = datetime.now(timezone.utc)
print(f"å½“å‰ UTC æ—¥æœŸå’Œæ—¶é—´: {current_utc_time}")

# å°†UTCæ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
beijing_timezone = timezone(timedelta(hours=8))
current_beijing_time = current_utc_time.astimezone(beijing_timezone)
print(f"å½“å‰åŒ—äº¬æ—¶é—´å’Œæ—¶é—´: {current_beijing_time}")

# è®¡ç®—æŸ¥è¯¢çš„æ—¥æœŸ(å‰ä¸€å¤©)
yesterday_beijing = current_beijing_time - timedelta(days=1)
yesterday_str = yesterday_beijing.strftime('%Y-%m-%d')
print(f"æŸ¥è¯¢çš„æ—¥æœŸ: {yesterday_str}")

def create_poster(results, date_str, output_folder):
    # åˆ›å»ºæµ·æŠ¥
    width = 1200
    height = 1600
    background_color = (255, 255, 255)
    text_color = (0, 0, 0)
    
    # åˆ›å»ºæ–°å›¾åƒ
    image = Image.new('RGB', (width, height), background_color)
    draw = ImageDraw.Draw(image)
    
    # åŠ è½½å­—ä½“
    try:
        title_font = ImageFont.truetype("C:\\Windows\\Fonts\\msyh.ttc", 40)
        content_font = ImageFont.truetype("C:\\Windows\\Fonts\\msyh.ttc", 24)
    except:
        title_font = ImageFont.load_default()
        content_font = ImageFont.load_default()
    
    # ç»˜åˆ¶æ ‡é¢˜
    title = f"ğŸ¤— Hugging Face {date_str} è®ºæ–‡æ—¥æŠ¥"
    title_bbox = draw.textbbox((0, 0), title, font=title_font)
    title_width = title_bbox[2] - title_bbox[0]
    draw.text(((width - title_width) // 2, 50), title, font=title_font, fill=text_color)
    
    # ç»˜åˆ¶å†…å®¹
    y = 150
    max_papers = 5  # é™åˆ¶æ˜¾ç¤ºçš„è®ºæ–‡æ•°é‡
    
    for i, result in enumerate(results[:max_papers]):
        # æå–æ ‡é¢˜å’Œæ‘˜è¦
        paper_info = result.get("paper", {})
        title = paper_info.get("title", "æ— æ ‡é¢˜")
        summary = paper_info.get("summary", "æ— æ‘˜è¦")
        
        # ç»˜åˆ¶è®ºæ–‡æ ‡é¢˜
        draw.text((50, y), f"{i+1}. {title}", font=content_font, fill=text_color)
        y += 40
        
        # å¤„ç†æ‘˜è¦æ–‡æœ¬æ¢è¡Œ
        words = summary.split()
        lines = []
        current_line = []
        
        for word in words:
            current_line.append(word)
            test_line = ' '.join(current_line)
            bbox = draw.textbbox((0, 0), test_line, font=content_font)
            if bbox[2] - bbox[0] > width - 100:  # 100æ˜¯å·¦å³è¾¹è·
                current_line.pop()
                lines.append(' '.join(current_line))
                current_line = [word]
        
        if current_line:
            lines.append(' '.join(current_line))
        
        # ç»˜åˆ¶æ‘˜è¦ï¼ˆé™åˆ¶è¡Œæ•°ï¼‰
        max_lines = 8
        for line in lines[:max_lines]:
            draw.text((50, y), line, font=content_font, fill=text_color)
            y += 30
        
        y += 50  # è®ºæ–‡ä¹‹é—´çš„é—´è·
    
    # æ·»åŠ åº•éƒ¨ä¿¡æ¯
    footer = "Generated by DeepSeek"
    footer_bbox = draw.textbbox((0, 0), footer, font=content_font)
    footer_width = footer_bbox[2] - footer_bbox[0]
    draw.text(((width - footer_width) // 2, height - 50), footer, font=content_font, fill=text_color)
    
    # ä¿å­˜å›¾ç‰‡
    os.makedirs(output_folder, exist_ok=True)
    output_path = os.path.join(output_folder, f"{date_str}_poster.png")
    image.save(output_path)
    print(f"æµ·æŠ¥å·²ä¿å­˜åˆ°ï¼š{output_path}")

def process_papers():
    # è¯»å–å…ƒæ•°æ®æ–‡ä»¶
    metadata_file = os.path.join('Paper_metadata_download', f"{yesterday_str}.json")
    if not os.path.exists(metadata_file):
        print(f"æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶ï¼š{metadata_file}")
        return
        
    try:
        with open(metadata_file, 'r', encoding='utf-8') as f:
            papers_data = json.load(f)
            
        results = []
        # ä½¿ç”¨tqdmæ˜¾ç¤ºè¿›åº¦æ¡
        for paper_str in tqdm(papers_data, desc="å¤„ç†è®ºæ–‡"):
            # è§£æpaperå­—ç¬¦ä¸²ä¸ºå­—å…¸
            paper_data = eval(paper_str)
            paper_info = paper_data.get("paper", {})
            
            if not paper_info:
                continue
                
            title = paper_info.get("title", "")
            summary = paper_info.get("summary", "")
            
            # è°ƒç”¨DeepSeek APIè¿›è¡Œç¿»è¯‘
            prompt = f"""è¯·å°†ä»¥ä¸‹è®ºæ–‡æ ‡é¢˜å’Œæ‘˜è¦ç¿»è¯‘æˆä¸­æ–‡ï¼Œä¿æŒå­¦æœ¯æ€§å’Œä¸“ä¸šæ€§ï¼š

æ ‡é¢˜ï¼š{title}

æ‘˜è¦ï¼š{summary}

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
æ ‡é¢˜ï¼š[ä¸­æ–‡æ ‡é¢˜]
æ‘˜è¦ï¼š[ä¸­æ–‡æ‘˜è¦]"""
            
            result = client.chat.completions.create(
                model="deepseek-chat",
                messages=[
                    {
                        "role": "system",
                        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯ç¿»è¯‘åŠ©æ‰‹ã€‚"
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                stream=False
            )
            
            # ä¿å­˜ç»“æœ
            results.append({
                "paper": paper_info,
                "translation": result.choices[0].message.content
            })
            
        # åˆ›å»ºè¾“å‡ºç›®å½•
        output_folder = 'HF-day-paper-deepseek'
        os.makedirs(output_folder, exist_ok=True)
        
        # ä¿å­˜ç¿»è¯‘ç»“æœ
        output_file = os.path.join(output_folder, f"{yesterday_str}_HF_deepseek_clean.json")
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(results, f, ensure_ascii=False, indent=4)
        print(f"ç¿»è¯‘ç»“æœå·²ä¿å­˜åˆ°ï¼š{output_file}")
        
        # ç”Ÿæˆæµ·æŠ¥
        create_poster(results, yesterday_str, output_folder)
        
    except Exception as e:
        print(f"å¤„ç†è®ºæ–‡æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")

if __name__ == "__main__":
    process_papers() 